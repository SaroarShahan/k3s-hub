# .github/workflows/deploy.yml

name: Deploy to K3s

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:
  workflow_call:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  K3S_SERVER: ${{ secrets.K3S_SERVER }}
  USER_NAME: saroarshahan

jobs:
  deploy:
    runs-on: self-hosted
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Configure kubectl for local k3s
      run: |
        mkdir -p $HOME/.kube
        # Copy local k3s config
        echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
        sudo chown $(whoami):staff $HOME/.kube/config

        sed -i 's/127.0.0.1/${{ secrets.K3S_SERVER }}/g' $HOME/.kube/config
        
        # Test connection
        kubectl get nodes
    
    - name: Create namespace if not exists
      run: |
        kubectl create namespace html-app --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Create GHCR pull secret
      run: |
        kubectl create secret docker-registry ghcr-secret \
          --docker-server=ghcr.io \
          --docker-username=${{ github.actor }} \
          --docker-password=${{ secrets.GHCR_PATH }} \
          --namespace=html-app \
          --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Update deployment with new image
      run: |
        # Get the latest image tag
        IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
        echo "Deploying image: $IMAGE_TAG"
        
        # Replace image tag in deployment
        sed -i "s|IMAGE_TAG|$IMAGE_TAG|g" k8s/deployment.yaml
        
        # Show what we're deploying
        cat k8s/deployment.yaml
        
    - name: Deploy to local k3s
      run: |
        # Apply all manifests
        kubectl apply -f k8s/ -n html-app
        
        # Wait for deployment to be ready
        kubectl rollout status deployment/html-app-deployment -n html-app --timeout=300s
   
    - name: Verify deployment
      run: |
        kubectl get pods -n html-app
        kubectl get services -n html-app

    - name: Deployment Summary
      if: always()
      run: |
        echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Server**: \`${{ env.K3S_SERVER }}\`" >> $GITHUB_STEP_SUMMARY  
        echo "- **Status**: ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: http://${{ env.K3S_SERVER }}:30100" >> $GITHUB_STEP_SUMMARY